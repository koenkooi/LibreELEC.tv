From 2a6db5400d804483d1d7a9afd87ebed4fe592a3f Mon Sep 17 00:00:00 2001
From: Lukas Rusak <lorusak@gmail.com>
Date: Tue, 1 Aug 2017 15:11:22 -0700
Subject: [PATCH 0/2] *** SUBJECT HERE ***

*** BLURB HERE ***

Lukas Rusak (2):
  [cmake] add FindV4L2.cmake
  VideoPlayer: add v4l2 support through ffmpeg

 cmake/modules/FindV4L2.cmake                       | 34 ++++++++++++++++++++++
 .../DVDCodecs/Video/DVDVideoCodecFFmpeg.cpp        | 31 +++++++++++++++++++-
 2 files changed, 64 insertions(+), 1 deletion(-)
 create mode 100644 cmake/modules/FindV4L2.cmake

-- 
2.9.4

From 67f165cdd69f15c26f9c9c8f00e45147bc7aafa6 Mon Sep 17 00:00:00 2001
From: Lukas Rusak <lorusak@gmail.com>
Date: Sat, 29 Jul 2017 12:04:50 -0700
Subject: [PATCH 1/2] [cmake] add FindV4L2.cmake

---
 cmake/modules/FindV4L2.cmake | 34 ++++++++++++++++++++++++++++++++++
 1 file changed, 34 insertions(+)
 create mode 100644 cmake/modules/FindV4L2.cmake

diff --git a/cmake/modules/FindV4L2.cmake b/cmake/modules/FindV4L2.cmake
new file mode 100644
index 0000000..8291a55
--- /dev/null
+++ b/cmake/modules/FindV4L2.cmake
@@ -0,0 +1,34 @@
+#.rst:
+# FindV4L2
+# -------
+# Finds the V4L2 header
+#
+# This will will define the following variables::
+#
+# V4L2_FOUND - system has V4L2
+# V4L2_LIBRARY - the V4L2 library
+# V4L2_INCLUDE_DIRS - the V4L2 include directory
+# V4L2_DEFINITIONS - the V4L2 definitions
+#
+
+if(PKG_CONFIG_FOUND)
+  pkg_check_modules(PC_V4L2 v4l2 QUIET)
+endif()
+
+find_path(V4L2_INCLUDE_DIR NAMES libv4l2.h
+                           PATHS ${PC_V4L2_INCLUDEDIR})
+
+find_library(V4L2_LIBRARY NAMES v4l2
+                          PATHS ${PC_V4L2_LIBDIR})
+
+include(FindPackageHandleStandardArgs)
+find_package_handle_standard_args(V4L2
+                                  REQUIRED_VARS V4L2_INCLUDE_DIR V4L2_LIBRARY)
+
+if(V4L2_FOUND)
+  set(V4L2_LIBRARIES ${V4L2_LIBRARY})
+  set(V4L2_INCLUDE_DIRS ${V4L2_INCLUDE_DIR})
+  set(V4L2_DEFINITIONS -DHAVE_V4L2=1)
+endif()
+
+mark_as_advanced(V4L2_INCLUDE_DIRS V4L2_LIBRARIES)
-- 
2.9.4


From 2a6db5400d804483d1d7a9afd87ebed4fe592a3f Mon Sep 17 00:00:00 2001
From: Lukas Rusak <lorusak@gmail.com>
Date: Sat, 29 Jul 2017 12:19:45 -0700
Subject: [PATCH 2/2] VideoPlayer: add v4l2 support through ffmpeg

---
 .../DVDCodecs/Video/DVDVideoCodecFFmpeg.cpp        | 31 +++++++++++++++++++++-
 1 file changed, 30 insertions(+), 1 deletion(-)

diff --git a/xbmc/cores/VideoPlayer/DVDCodecs/Video/DVDVideoCodecFFmpeg.cpp b/xbmc/cores/VideoPlayer/DVDCodecs/Video/DVDVideoCodecFFmpeg.cpp
index 461bbe0..d354128 100644
--- a/xbmc/cores/VideoPlayer/DVDCodecs/Video/DVDVideoCodecFFmpeg.cpp
+++ b/xbmc/cores/VideoPlayer/DVDCodecs/Video/DVDVideoCodecFFmpeg.cpp
@@ -365,7 +365,36 @@ bool CDVDVideoCodecFFmpeg::Open(CDVDStreamInfo &hints, CDVDCodecOptions &options
   m_formats.push_back(AV_PIX_FMT_NONE); /* always add none to get a terminated list in ffmpeg world */
   m_processInfo.SetSwDeinterlacingMethods();
 
-  pCodec = avcodec_find_decoder(hints.codec);
+  switch(hints.codec)
+  {
+    case AV_CODEC_ID_H263:
+      pCodec = avcodec_find_decoder_by_name("h263_v4l2m2m");
+      break;
+    case AV_CODEC_ID_H264:
+      pCodec = avcodec_find_decoder_by_name("h264_v4l2m2m");
+      break;
+    case AV_CODEC_ID_MPEG4:
+      pCodec = avcodec_find_decoder_by_name("mpeg4_v4l2m2m");
+      break;
+    case AV_CODEC_ID_MPEG1VIDEO:
+      pCodec = avcodec_find_decoder_by_name("mpeg1_v4l2m2m");
+      break;
+    case AV_CODEC_ID_MPEG2VIDEO:
+      pCodec = avcodec_find_decoder_by_name("mpeg2_v4l2m2m");
+      break;
+    case AV_CODEC_ID_VC1:
+      pCodec = avcodec_find_decoder_by_name("vc1_v4l2m2m");
+      break;
+    case AV_CODEC_ID_VP8:
+      pCodec = avcodec_find_decoder_by_name("vp8_v4l2m2m");
+      break;
+    case AV_CODEC_ID_VP9:
+      pCodec = avcodec_find_decoder_by_name("vp9_v4l2m2m");
+      break;
+  }
+
+  if (pCodec == NULL)
+    pCodec = avcodec_find_decoder(hints.codec);
 
   if(pCodec == NULL)
   {
-- 
2.9.4

